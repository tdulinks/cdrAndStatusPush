# 语音服务推送系统

[English Documentation](README.en.md)

## MIT License

Copyright (c) 2025 语音服务推送系统

特此免费授予任何获得本软件副本和相关文档文件（"软件"）的人不受限制地处理本软件的权利，包括但不限于使用、复制、修改、合并、发布、分发、再许可和/或出售本软件副本的权利，以及允许获得本软件的人这样做，但须符合以下条件：

上述版权声明和本许可声明应包含在本软件的所有副本或主要部分中。

本软件按"原样"提供，不提供任何形式的明示或暗示的保证，包括但不限于对适销性、特定用途的适用性和非侵权性的保证。在任何情况下，作者或版权持有人均不对任何索赔、损害或其他责任负责，无论是在合同诉讼、侵权行为还是其他方面，产生于本软件或与本软件的使用或其他交易有关。

## 项目介绍
该系统模拟运营商的通话记录和状态推送功能，为第三方应用提供标准的推送接口。系统主要包含两种推送类型：

1. 通话记录推送(CDR) - 在通话结束后推送完整话单数据，类似运营商的详单推送
2. 呼叫状态推送 - 在通话过程中实时推送状态变更，包括呼叫、振铃、接听、挂断等状态

本系统可用于：
- 模拟运营商通话记录推送测试
- 开发通话管理系统
- 集成到呼叫中心系统
- 对接第三方话务系统

## 技术规范

### 接口信息
- 协议：HTTP/HTTPS
- 请求方式：POST
- 数据格式：JSON
- 字符编码：UTF-8
- 认证方式：无需签名认证
- 成功响应：HTTP 2xx

### 服务类型
- 100：语音SIP服务（模拟运营商固话/移动业务）
- 200：隐私号服务（模拟运营商中间号业务）

### 重试机制
系统内置重试机制，具体如下：

| 重试次数 | 间隔时间 | 说明 |
|---------|---------|------|
| 1 | 立即 | 首次失败后立即重试 |
| 2 | 5秒 | 第二次重试 |
| 3 | 30秒 | 第三次重试 |
| 4 | 5分钟 | 第四次重试 |
| 5 | 30分钟 | 最终重试 |

## 使用注意事项
1. 隐私号相关字段仅在 serviceType=200 时有效
2. 注意区分毫秒级时间戳和秒级时间戳
3. userData 字段最大支持 2048 字符
4. 建议接口响应时间控制在 3 秒以内

## 系统安装和配置

### 环境要求
- Go 1.16 或以上版本
- 配置文件：config/config.yaml

### 安装步骤
1. 克隆代码仓库
2. 进入项目目录：`cd cdr`
3. 安装依赖：`go mod download`
4. 修改配置文件 config/config.yaml

## 服务启动和停止

### 启动服务
1. CDR推送服务：
   ```bash
   go run cmd/cdr/main.go
   ```
2. 状态推送服务：
   ```bash
   go run cmd/status/main.go
   ```

### 停止服务
使用 Ctrl+C 终止服务进程

## 接口调用示例

### CDR推送接口
```json
{
  "callId": "202312010001",
  "serviceType": 100,
  "callerNumber": "1380000001",
  "calleeNumber": "02188888888",
  "startTime": 1701388800000,
  "endTime": 1701389100000,
  "duration": 300,
  "userData": "test-data"
}
```

### 状态推送接口
```json
{
  "callId": "202312010001",
  "serviceType": 100,
  "status": "ANSWERED",
  "timestamp": 1701388800000
}
```

## 常见问题

1. **推送失败如何处理？**
   - 检查网络连接是否正常
   - 确认目标服务器是否可访问
   - 查看日志文件排查具体错误

2. **如何修改推送重试配置？**
   - 在配置文件中调整重试次数和间隔时间
   - 重启服务使配置生效

3. **如何查看推送日志？**
   - 日志文件位于 logs 目录
   - 按日期命名，方便查询

## 文档
详细接口规范请参考 [语音服务推送系统开发文档](语音服务推送系统开发文档.md)